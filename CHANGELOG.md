# 更新日志 (Changelog)

### ✨ v1.1.3 - 权限、连续消息记录与主题增强

#### 【新功能】
- 引入 `QUOTE_ALLOW_BOT_RECORD` 配置项，允许控制是否记录Bot自身消息。
- 超级用户现在可以无视 `QUOTE_ALLOW_SELF_RECORD` 配置，自由记录自己的消息。
- 语录上传者现在可以无视 `DELETE_ADMIN_LEVEL` 权限等级，随时删除自己上传的语录。
- 增强语录主题系统，支持动态皮肤解析和皮肤继承机制。
- 新增“手写回忆”主题皮肤。
- 经典主题现在会显示 `[图片]` 占位符，而非忽略图片内容。
- `记录` 和 `生成` 命令新增 `-o|--only` 选项，支持仅记录/生成被回复用户的连续消息。

#### 【性能优化】
- 优化上传流程，在发现重复图片哈希时跳过OCR识别，减少资源消耗。
- `OCRService` 和 `QuoteService` 内部缓存机制升级为 `TTLCache`，提升性能。

#### 【代码重构】
- UI资产目录结构重构，将组件和页面模板从 `assets` 移动到 `templates` 目录。
- 移除 `CacheRegistry` 和 `DataAccess`，直接通过 `Quote` 模型进行数据库操作，简化数据访问层。
- 统一图片哈希计算方式，直接使用 `hashlib.md5`。

#### 【问题修复】
- 改进嵌套引用消息中的 `@` 提及解析和 HTML 渲染，确保显示正确。

#### 【文档更新】
- 新增 `CHANGELOG.md` 文件，详细记录版本更新历史。
- 更新 `README.md`，包括版本号、依赖说明、配置项描述、权限说明和引擎选择建议。
- 明确AI识别为首选方案，本地OCR为可选备用。

#### 【构建】
- `requirements.txt` 添加 `cachetools` 依赖，并调整OCR相关依赖为可选。
- 新增 `Muyao-Softbrush.ttf` 字体文件。

### 🚀 v1.1.2 - 权限优化

#### ✨ 新功能与优化
- **超级用户特权**: 超级用户现在可以无视 `QUOTE_ALLOW_SELF_RECORD` 配置，自由记录自己的消息。
- **上传者自治**: 语录的上传者现在可以无视 `DELETE_ADMIN_LEVEL` 权限等级，随时删除自己上传的语录。
- 📚 **文档更新**: 优化了 `README.md`，明确了AI识别为首选方案，本地OCR为可选备用，并更新了相关配置说明和新增功能用法。

### 🎉 v1.1.0 - UI系统重构与命令增强

#### 🎨 UI渲染系统重构
- 🏗️ **模块化UI系统**：引入全新的组件化UI渲染架构，替换旧版主题机制
  - 新增 `components` 目录存放语录卡片组件（`classic`, `qq-native`）
  - 新增 `pages` 目录存放统计页面组件（`hot_quotes`, `quote-sequence-page`）
  - 注册 `@quote` 模板命名空间至渲染服务，实现动态UI渲染
- 📋 **数据模型规范**：新增 `QuoteCardData`, `QuoteSequenceData`, `HotQuotesPageData` 等 Pydantic 模型
- 🗑️ **移除旧版资源**：废弃 `templates` 和 `themes` 目录下的旧版HTML/CSS模板

#### ⚡ 命令系统增强
- 🔄 **命令结构优化**：
  - 合并 `删除`, `addtag`, `deltag` 命令至统一的 `quote manage` 命令组
  - `语录统计` 更新为子命令结构（`quote stats hot/top-uploaders/top-quoted`）
- 📝 **连续消息记录**：`记录` 和 `生成` 命令新增 `-n|--num` 选项，支持连续多条消息语录生成
- 🎯 **主题选择增强**：
  - 支持通过 `-s [主题序号]` 使用数字快速选择主题
  - 新增纯文本消息专属主题配置（`QUOTE_TEXT_ONLY_THEME`）
  - `quote theme` 命令支持使用序号或名称切换主题
- 🎨 **渲染能力提升**：优化消息内容解析，支持 `@` 提及、内联图片和嵌套引用消息渲染

#### ⚙️ 配置与优化
- 🆕 **新增配置项**：
  - `QUOTE_TEXT_ONLY_THEME`：为纯文本（含@）单条语录指定专属主题
  - `QUOTE_ALLOW_SELF_RECORD`：控制是否允许用户记录自己的消息
- 🔧 **配置调整**：
  - `THEME` 默认值更改为 `qq-native`
  - `DELETE_ADMIN_LEVEL` 默认值调整为 `5`
- 🔍 **内部优化**：
  - 语录重复检查改为主要基于图片哈希值
  - 头像获取统一使用 `avatar_service`
  - OCR 服务增加引擎实例空值检查，提高稳定性
  - 移除 `ThemeService`，主题选择逻辑集成至新渲染流程

---

### 🔄 历史版本

### 🎉 v1.0.0 - 重大版本更新

#### 🔧 核心功能重构
- 🎨 **主题系统**：引入语录主题系统，支持HTML/CSS/JS自定义渲染
- 🔧 **查询优化**：重构语录查询逻辑，消除重复代码并提升性能
- 🤖 **AI升级**：升级AI-OCR功能，优先使用LLM服务并保留本地降级方案

#### ✨ 新增功能
- 📋 新增 `语录主题` 命令查看可用主题
- 🛠️ 新增 `语录管理` 主命令，支持批量删除和清理操作
- 🎯 支持通过 `-s [主题ID]` 参数指定语录生成主题
- 🎨 内置三种精美主题：**经典黑**、**深空蓝**、**手写回忆**
- 🔧 新增高级管理命令，支持按用户、关键词批量管理语录

#### 🚀 优化改进
- 🗂️ **路径优化**：支持相对路径存储，提升数据可移植性
- 🚀 **消息处理**：统一消息处理方式，简化回复和消息解析
- 🧹 **渲染升级**：移除旧版Pilmoji库，采用现代HTML渲染方案
- ⚡ **防重复**：避免短期内重复发送相同语录
- 📊 **统计增强**：支持跨群组查询和更详细的数据分析
- 🎛️ **配置完善**：新增主题和权限配置选项

---

#### v0.4.5
- ✅ 支持多关键词AND模式搜索
- ✅ 支持自定义语录图片保存路径
- ✅ 统一图片格式为PNG并添加转换功能
- ✅ 优化图片文本字体自适应调整
- 🐛 修复删除语录时图片文件同步删除
- 🔧 重构文件路径操作使用pathlib
- 🔧 增强表情符号加载和文件处理健壮性

#### v0.4.4
- ✨ 添加 Gemini AI 识别功能
- 🎨 优化语录显示效果
- 🐛 修复用户名显示问题
- 📊 添加语录统计功能

#### v0.4.3
- ⚙️ 添加字体配置选项
- 🎨 优化语录生成效果
- 🐛 修复多处 Bug

#### v0.4.2
- 📦 添加批量上传和备份功能
- 🔍 优化 OCR 识别效果
- 🐛 修复标签管理问题

#### v0.4.1
- 🔍 添加多种 OCR 引擎支持
- 🔍 优化语录搜索功能
- 🐛 修复图片处理问题

#### v0.4.0
- 🎉 初始版本发布
