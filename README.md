# 群聊语录插件

一款QQ群语录库——支持上传聊天截图为语录，随机投放语录，关键词搜索语录精准投放。支持多种识别方式，包括Gemini AI识别和OCR识别。

本插件是 [nonebot_plugin_quote](https://github.com/RongRongJi/nonebot_plugin_quote) 的真寻机器人适配版本，在原版基础上进行了大量优化和功能扩展。

## 功能特点

- 上传聊天截图为语录
- 随机投放语录
- 关键词搜索语录精准投放
- 支持多种识别方式（Gemini AI、EasyOCR、PaddleOCR）
- 支持语录标签管理
- 支持批量上传和备份
- 支持文本消息生成语录图片
- 支持用户语录统计和热门语录排行

## 安装说明

### 方法一：使用真寻插件商店安装

1. 在真寻机器人后台管理界面中，进入"插件商店"
2. 搜索"群聊语录"插件
3. 点击"安装"按钮
4. 安装完成后，在"插件管理"中启用该插件

### 方法二：手动安装

1. 下载本项目代码
2. 将整个文件夹放入真寻机器人的 `plugins` 目录下
3. 重启真寻机器人
4. 在"插件管理"中启用该插件

## 安装依赖

### 基础依赖

```bash
pip install easyocr
```

### 可选依赖

如果你想使用 PaddleOCR 引擎，需要安装以下依赖：

```bash
pip install paddlepaddle
pip install paddleocr
```

如果你想使用 Gemini AI 识别功能，需要安装以下依赖：

```bash
pip install httpx
```

## 配置说明

在真寻机器人的配置界面中，可以找到以下配置项：

### OCR 引擎配置

- **OCR_ENGINE**: OCR引擎选择，可选值: `easyocr`, `paddleocr`，默认为 `easyocr`
- **OCR_USE_GPU**: 是否使用GPU加速OCR识别，默认为 `False`

#### EasyOCR 与 PaddleOCR 对比

##### EasyOCR 特点

**优点**：

- 安装简单，依赖少
- 支持多种语言
- 稳定性好，兼容性强
- 内存占用较小

**缺点**：

- 识别速度较慢
- 对复杂布局支持有限
- 准确率略低

**适用场景**：

- 简单文本识别
- 资源受限环境
- 需要多语言支持

##### PaddleOCR 特点

**优点**：

- 识别速度快
- 识别准确率高
- 支持更多文本场景
- 对复杂布局处理更好

**缺点**：

- 安装复杂，依赖多
- Windows兼容性问题
- 内存占用大
- 初始化时间长

**适用场景**：

- 复杂布局文本
- 高精度需求
- 有GPU加速条件

##### 性能对比

| 特性 | EasyOCR | PaddleOCR |
|------|---------|-----------|
| 初始化时间 | 较短 | 较长 |
| 内存占用 | 中等 | 较高 |
| 识别速度 | 较慢 | 较快 |
| 准确率 | 中等 | 较高 |

##### 选择建议

- 如果你的设备配置较低或追求稳定性，建议使用 EasyOCR
- 如果你需要更高的识别准确率且设备配置较高，建议使用 PaddleOCR
- 如果遇到 PaddleOCR 安装或运行问题，可以回退到 EasyOCR

### AI 识别配置

- **AI_ENABLED**: 是否启用AI识别功能（启用后会先尝试使用AI识别，失败则降级使用OCR），默认为 `False`
- **AI_CONFIG**: AI配置（包含API密钥、模型名称和API基础URL）

  ```python
  {
      "api_key": "你的Gemini API密钥",
      "model_name": "gemini-2.0-flash-exp",
      "api_base": "https://generativelanguage.googleapis.com/v1beta"
  }
  ```

### 字体配置

- **FONT_NAME**: 正文字体名称（位于FONT_PATH目录下，留空则使用第一个可用字体）
- **AUTHOR_FONT_NAME**: 作者字体名称（位于FONT_PATH目录下，留空则使用第一个可用字体）

## 使用方法

### 基本命令

- `语录`: 随机发送一条语录
- `语录 [关键词]`: 搜索并发送包含关键词的语录
- `语录 @用户`: 随机发送该用户的语录
- `语录 @用户 [关键词]`: 搜索并发送该用户包含关键词的语录
- `上传 [图片]`: 上传图片作为语录
- `上传 [回复消息]`: 将回复的消息上传为语录
- `记录 [回复消息]`: 将回复的文本消息生成为语录并保存
- `生成 [回复消息]`: 将回复的文本消息生成为语录但不保存

### 标签管理

- `标签/tag [回复语录]`: 查看语录的所有标签
- `addtag [标签1] [标签2] [回复语录]`: 为语录添加标签
- `deltag [标签1] [标签2] [回复语录]`: 删除语录的标签

### 管理命令

- `删除 [回复语录]`: 删除回复的语录
- `删除关键词 [关键词]`: 删除包含关键词的语录
- `删除关键词 @用户 [关键词]`: 删除该用户包含关键词的语录

### 统计命令

- `语录统计 热门`: 显示群内热门语录排行
- `语录统计 高产上传`: 显示上传语录最多的用户排行
- `语录统计 高产被录`: 显示被记录语录最多的用户排行

## 注意事项

1. 使用 PaddleOCR 引擎可能需要较高的系统配置
2. 首次使用 OCR 引擎时会下载模型文件，可能需要一些时间
3. 如果使用 GPU 加速，请确保已正确安装 CUDA 和相应的深度学习框架
4. 如果 PaddleOCR 初始化失败（例如缺少 shm.dll 等依赖项），插件会自动回退到 EasyOCR
5. Windows 用户可能需要安装 Visual C++ Redistributable 以解决 PaddleOCR 的依赖问题
6. 使用 Gemini AI 识别功能需要有效的 API 密钥，可以在 [Google AI Studio](https://makersuite.google.com/app/apikey) 获取

### 解决 PaddleOCR 依赖问题

如果遇到 `找不到指定的程序。 Error loading "shm.dll"` 等错误，可以尝试以下解决方案：

1. 安装 Visual C++ Redistributable：
   - 下载并安装 [Microsoft Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)

2. 确保 PyTorch 正确安装：

   ```bash
   pip uninstall torch
   pip install torch
   ```

3. 如果问题仍然存在，建议使用 EasyOCR 引擎：
   - 在配置中将 `OCR_ENGINE` 设置为 `easyocr`

## AI 识别功能说明

启用 AI 识别功能后，插件会先尝试使用 Gemini AI 识别图片中的文字，如果识别失败（例如 API 调用失败或返回空结果），会自动降级使用配置的 OCR 引擎进行识别。

### AI 识别特点

**优点**：

- 更高的识别准确率，特别是对于复杂布局和多语言混合的截图
- 能够理解上下文，提取语义信息
- 对聊天截图中的表情、特殊符号处理更好
- 内置重试机制，最多尝试 3 次识别
- 识别结果缓存，相同图片不会重复调用 API
- 自动降级到 OCR 引擎，保证识别的可靠性

**缺点**：

- 需要有效的 API 密钥
- 依赖网络连接
- 可能有 API 调用次数限制
- 处理时间可能较长（受网络影响）

### AI 识别与 OCR 引擎对比

| 特性 | Gemini AI | EasyOCR | PaddleOCR |
|------|-----------|---------|-----------|
| 准确率 | 最高 | 中等 | 较高 |
| 处理速度 | 受网络影响 | 较慢 | 较快 |
| 对复杂布局支持 | 极佳 | 有限 | 良好 |
| 多语言支持 | 极佳 | 良好 | 良好 |
| 对表情符号识别 | 支持 | 不支持 | 不支持 |
| 上下文理解 | 支持 | 不支持 | 不支持 |
| 依赖条件 | API密钥+网络 | 本地计算 | 本地计算 |
| 资源占用 | 低（云端处理） | 中等 | 高 |

### 识别方式推荐

- 如果追求最高准确率且有稳定网络连接，建议启用 AI 识别功能
- 如果在无网络环境或希望快速响应，建议使用 PaddleOCR
- 如果设备配置有限，建议使用 EasyOCR
- 最佳实践：启用 AI 识别功能，同时将 OCR_ENGINE 设置为 PaddleOCR，以获得最佳的识别效果和容错能力

## 贡献指南

欢迎为本项目做出贡献！你可以通过以下方式参与：

1. 提交 Issue 报告 Bug 或提出新功能建议
2. 提交 Pull Request 改进代码或添加新功能
3. 完善文档或修正错误

## 与原版的区别

本插件基于 [nonebot_plugin_quote](https://github.com/RongRongJi/nonebot_plugin_quote) v0.3.9 版本进行改造，主要改进和新增功能如下：

### 架构优化

- **代码重构**：按功能模块化拆分，将原本单文件结构重构为多模块设计
- **数据库支持**：使用 Tortoise ORM 替代原版的 JSON 文件存储，提高数据管理效率和可靠性

### 新增功能

- **Gemini AI 识别**：接入 Google Gemini AI 进行图片文字识别，大幅提高识别准确率
- **多引擎支持**：支持 EasyOCR、PaddleOCR 和 Gemini AI 三种识别方式，可根据需求切换
- **用户语录查询**：支持 `语录 @用户` 查询特定用户的语录
- **语录统计功能**：新增热门语录排行、高产上传用户排行和高产被录用户排行
- **字体配置优化**：支持通过配置文件指定字体名称，自动查找可用字体
- **用户界面优化**：改进语录显示效果，优化用户名和语录内容的展示方式

### 用户体验提升

- **命令响应优化**：更友好的命令提示和错误反馈
- **语录展示改进**：优化语录图片生成效果，支持显示用户头像和名称
- **降级处理**：AI 识别失败时自动降级使用 OCR 引擎，保证功能可用性

## 版本信息

当前版本：v0.4.4

### 更新日志

#### v0.4.4

- 添加 Gemini AI 识别功能
- 优化语录显示效果
- 修复用户名显示问题
- 添加语录统计功能

#### v0.4.3

- 添加字体配置选项
- 优化语录生成效果
- 修复多处 Bug

#### v0.4.2

- 添加批量上传和备份功能
- 优化 OCR 识别效果
- 修复标签管理问题

#### v0.4.1

- 添加多种 OCR 引擎支持
- 优化语录搜索功能
- 修复图片处理问题

#### v0.4.0

- 初始版本发布

## 致谢

特别感谢 [RongRongJi](https://github.com/RongRongJi) 开发的原版 [nonebot_plugin_quote](https://github.com/RongRongJi/nonebot_plugin_quote) 插件，本项目在其基础上进行了改进和扩展。

## 许可证

本项目采用 MIT 许可证，详情请参阅 [LICENSE](LICENSE) 文件。
