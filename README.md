# 🤖 群聊语录 (Quote)

<p align="center">
  <a href="https://github.com/webjoin111/zhenxun_plugin_quote"><img src="https://img.shields.io/badge/Version-v0.4.5-blue.svg" alt="Version"></a>
  <a href="https://github.com/webjoin111/zhenxun_plugin_quote/blob/main/LICENSE"><img src="https://img.shields.io/badge/License-MIT-green.svg" alt="License"></a>
  <a href="https://github.com/zhenxun-org/zhenxun_bot"><img src="https://img.shields.io/badge/Framework-ZhenxunBot-ff69b4.svg" alt="Framework"></a>
</p>

一款功能强大的QQ群语录库插件，专为 [真寻（Zhenxun）](https://github.com/zhenxun-org/zhenxun_bot) 机器人框架设计。支持从聊天截图、回复消息中创建语录，并通过关键词、@用户等多种方式精准投放。集成了先进的 AI 视觉模型识别与多种本地 OCR 引擎，并拥有高度可定制的 HTML 主题系统。

本插件是 [nonebot_plugin_quote](https://github.com/RongRongJi/nonebot_plugin_quote) 的真寻机器人适配版本，在原版基础上进行了深度重构、性能优化和大量功能扩展。

## ✨ 功能特性

- **多源录入**: 支持从图片、回复文本消息等多种方式轻松创建语录。
- **智能识别**:
    - **AI 优先**: 优先使用真寻框架集成的多模态大模型（如 Gemini, GLM-4V）进行识别，准确率高，能理解上下文。
    - **OCR 降级**: AI 识别失败或未启用时，自动降级至本地 OCR 引擎。
    - **双引擎保障**: 支持 `EasyOCR` 和 `PaddleOCR`，主引擎失败后自动尝试备用引擎，最大化成功率。
- **灵活查询**:
    - 支持随机、关键词（AND 模式）、`@用户`、`@用户 + 关键词` 等多种组合查询。
    - 查询结果若文件不存在，会自动清理无效数据并尝试返回另一条，具备“数据自愈”能力。
- **强大的主题系统**:
    - **HTML/CSS 驱动**: 语录卡片完全由 HTML 模板生成，美观且易于定制。
    - **主题继承**: 子主题可以继承父主题的模板和样式，只需少量修改即可创建新风格，扩展性极强。
    - **自定义字体**: 主题可捆绑专属字体，实现更丰富的视觉效果。
- **数据统计与排行**:
    - **热门语录**: 生成图文并茂的热门语录排行榜。
    - **用户排行**: 统计“高产上传”和“高产被录”用户，并生成可视化图表。
- **精细化管理**:
    - **标签系统**: 为语录添加、删除、查询标签，方便归类管理。
    - **高级管理**: 提供面向超级用户的批量删除工具，可按关键词、用户、甚至清理已退群成员的语录。
- **持久化存储**: 使用 Tortoise ORM 进行数据库存储，稳定可靠，告别文件IO。

## 📥 安装

### 方式一：通过真寻插件商店

1.  进入真寻机器人 WebUI -> `插件商店`。
2.  搜索 `群聊语录`。
3.  点击 `安装` 并等待完成。
4.  在 `插件管理` 中启用插件。

### 方式二：手动安装

1.  从本仓库下载插件源码（`clone` 或下载 zip）。
2.  将 `quote` 文件夹完整放入真寻机器人的 `plugins` 目录下。
3.  重启真寻机器人。

## ⚙️ 依赖

插件会自动处理大部分依赖。您可能需要根据需求手动安装以下可选依赖：

- **基础 OCR (默认)**:
    ```bash
    pip install easyocr
    ```

- **可选的高性能 OCR**: (推荐，但安装可能较复杂)
    ```bash
    # 安装 PaddlePaddle 核心库（请根据您的环境选择合适的版本，CPU/GPU）
    pip install paddlepaddle
    # 安装 PaddleOCR
    pip install paddleocr
    ```

- **分词优化**: (用于更精准的中文标签和搜索)
    ```bash
    pip install spacy_pkuseg
    ```

## 🛠️ 配置项
所有配置均可在真寻机器人 WebUI -> `配置中心` -> `quote` 模块下进行修改。

| 配置项               | 说明                                                                                                         | 默认值                                       |
| :------------------- | :----------------------------------------------------------------------------------------------------------- | :------------------------------------------- |
| `OCR_ENGINE`         | 本地 OCR 引擎选择。可选值：`easyocr`, `paddleocr`。                                                          | `easyocr`                                    |
| `OCR_USE_GPU`        | 是否为本地 OCR 引擎启用 GPU 加速。                                                                           | `False`                                      |
| `AI_ENABLED`         | **[推荐]** 是否启用 AI 识别。启用后将优先使用真寻的 LLM 服务，失败后降级到本地 OCR。                         | `False`                                      |
| `OCR_AI_MODEL`       | 用于图片识别的多模态大模型。格式为 `ProviderName/ModelName`。需在真寻的 `AI` 配置组中配置好对应的 Provider。 | `Gemini/gemini-2.5-flash-lite-preview-06-17` |
| `QUOTE_PATH`         | 语录图片保存路径。留空则使用默认路径 `data/quote/images`。                                                   | `""`                                         |
| `QUOTE_THEME`        | 生成语录卡片时使用的主题列表，会从中随机选择。填入 `all` 则在所有可用主题中随机。                            | `["classic"]`                                |
| `DELETE_ADMIN_LEVEL` | 使用 `删除` 命令所需的权限等级（0:群员, 1:管理员, 2:群主）。                                                 | `1`                                          |

> **注意**: AI 识别功能依赖于真寻框架的 `llm` 服务。请确保您已在 WebUI -> `配置中心` -> `AI` 模块下正确配置了至少一个支持视觉功能的大模型提供商（如 Gemini, GLM-4V 等）。

## 📖 使用说明

### 核心功能 (所有用户)

-   `语录`：随机发送一条语录。
-   `语录 [关键词]`：搜索包含指定关键词的语录。
-   `语录 [词1] [词2]`：搜索同时包含所有关键词的语录 (AND逻辑)。
-   `语录 @用户`：随机发送指定用户的语录。
-   `语录 @用户 [关键词]`：搜索指定用户包含关键词的语录。
-   `上传 [图片]`：上传图片作为语录。
-   `上传` (回复图片消息)：将回复的图片上传为语录。
-   `记录` (回复文本消息)：将回复的文本生成语录图片并保存。

### 主题与生成

-   `语录主题`：查看所有可用的语录卡片主题。
-   `记录 -s [主题ID]`：在记录时使用指定主题生成图片。
-   `生成` (回复文本消息)：预览生成的语录图片，但不会保存。
-   `生成 -s [主题ID]`：使用指定主题进行预览。

### 标签管理 (管理员权限)

-   `标签` / `tag` (回复语录)：查看该语录的所有标签。
-   `addtag [标签1] [标签2]...` (回复语录)：为语录添加一个或多个标签。
-   `deltag [标签1] [标签2]...` (回复语录)：删除语录的一个或多个标签。

### 语录统计

-   `语录统计 热门 [数量]`：显示群内热门语录排行 (默认10条)。
-   `语录统计 高产上传 [数量]`：显示上传语录最多的用户排行。
-   `语录统计 高产被录 [数量]`：显示被记录语录最多的用户排行。
> 超级用户可使用 `-g [群号]` 在任意位置查询指定群的统计。

### 基础管理 (管理员权限)

-   `删除` (回复语录)：删除回复的语录图片及其记录。

### 高级管理 (超级用户权限)

-   `语录管理 删除关键词 [词1] [词2]...`
    > 删除包含任一关键词的语录 (OR逻辑)。
    > 可附加 `--uploader [@/QQ号]` 或 `--quoted [@/QQ号]` 进行筛选。
-   `语录管理 清空全部 --uploader [@/QQ号]`
    > 删除指定上传者的所有语录。
-   `语录管理 清空全部 --quoted [@/QQ号]`
    > 删除被记录的指定用户的所有语录。
-   `语录管理 清空全部 --group [群号]`
    > **[高危]** 删除指定群号的所有语录。
-   `语录管理 清理 退群用户`
    > 自动清理所有已退群用户的相关语录。
-   `语录管理 ... -g [群号]`
    > 在任意位置对指定群聊执行上述高级管理操作。

---

## 🚀 引擎对比与选择建议

| 特性           | AI 视觉模型 (推荐)     | PaddleOCR            | EasyOCR              |
| :------------- | :--------------------- | :------------------- | :------------------- |
| **准确率**     | **最高**               | 较高                 | 中等                 |
| **识别速度**   | 受网络影响             | 较快                 | 较慢                 |
| **安装难度**   | **无需额外安装**       | 复杂                 | 简单                 |
| **资源占用**   | **极低 (云端处理)**    | 较高                 | 中等                 |
| **上下文理解** | **是**                 | 否                   | 否                   |
| **适用场景**   | 复杂截图、手写、艺术字 | 快速本地识别、无网络 | 基础识别、低配置环境 |

**最佳实践**: 启用 `AI_ENABLED`，并将 `OCR_ENGINE` 设置为 `paddleocr`。这样可以享受 AI 带来的高准确率，同时在 AI 服务不可用时，拥有一个强大的本地备用方案。

---
## 🎨 字体管理与自定义

本插件提供了强大且灵活的字体管理系统，让您轻松定制语录卡片的视觉风格。

### 字体库

插件会从**两个位置**按顺序查找您指定的字体文件：

1.  **插件字体库 (高优先级)**: `plugins/quote/assets/fonts/`
    -   这里存放插件自带的字体和主题专属字体。插件会优先在这里查找。
    -   插件已内置 `SarasaFixedSC-Regular.ttf` 作为默认后备字体。

2.  **真寻全局字体库 (低优先级)**: `resources/font/`
    -   这是真寻机器人的全局字体目录。如果插件字体库中没找到，会来这里查找。
    -   **您可以将自己喜欢的 `.ttf` 或 `.otf` 字体文件直接放入此文件夹**，即可在配置或主题中通过文件名调用它们，供所有插件使用。

### 如何设置字体？

您可以通过两种方式来控制字体，它们有不同的优先级：

#### 方式一：全局默认字体 (WebUI 配置 & config.yaml文件)

在真寻后台 **[插件配置] -> [quote]** 页面，您可以设置全局默认字体：

-   **`DEFAULT_TEXT_FONT`**: 设置所有语录卡片**正文**的默认字体。
-   **`DEFAULT_AUTHOR_FONT`**: 设置所有语录卡片**作者署名**的默认字体。

> **注意**：您只需要填写**字体文件名**（例如 `MyCustomFont.ttf`），插件会自动在上述两个字体库中查找。

#### 方式二：主题专属字体 (高级)

主题开发者可以在主题的 `theme.json` 文件中为该主题指定专属字体，这将**覆盖**全局默认设置。

**示例** (`my-theme/theme.json`):
```json
{
  "name": "我的专属主题",
  "assets": {
    "text_font_file": "SourceHanSans-Bold.otf", // 正文使用思源黑体-粗
    "author_font_file": "Handwritten-Cool.ttf"  // 作者使用一个手写体
  }
}
```

### 字体选择优先级
系统会按照以下顺序来决定最终使用哪个字体：

1.  **主题指定**: `theme.json` 中定义的字体文件名优先级最高。
2.  **全局配置**: 如果主题未指定，则使用您在 WebUI 中设置的字体文件名。
3.  **插件内置**: 如果以上两项都未指定或指定的文件不存在，系统将使用插件内置的 `SarasaFixedSC-Regular.ttf` 作为最终的后备字体，确保图片总能正常生成。

---
## 🎨 主题系统详解

本插件的特色之一就是基于HTML的强大主题系统。您可以轻松创造属于自己风格的语录卡片。

### 🖼️ 内置主题预览

插件内置了三种精美主题，每种都有独特的视觉风格：

#### 📖 Classic (经典黑)
<div align="center">
  <img src="./image/classic.png" alt="经典黑主题预览" width="400"/>
</div>

- **风格**: 简洁优雅的黑色主题
- **特点**: 经典的设计，适合各种场景
- **主题ID**: `classic`

#### 🌌 Classic-Blue (深空蓝)
<div align="center">
  <img src="./image/classic-blue.png" alt="深空蓝主题预览" width="400"/>
</div>

- **风格**: 现代科技感的深蓝色主题
- **特点**: 深邃的蓝色背景，营造科技感氛围
- **主题ID**: `classic-blue`

#### ✍️ Handwritten (手写回忆)
<div align="center">
  <img src="./image/handwritten.png" alt="手写回忆主题预览" width="400"/>
</div>

- **风格**: 温馨的手写字体主题
- **特点**: 使用手写字体，营造温暖回忆的感觉
- **主题ID**: `handwritten`

### 📁 主题结构
-   所有主题都存放在 `quote/assets/themes/` 目录下。
-   每个主题是一个独立的文件夹，文件夹名即为**主题ID**。
-   一个典型的主题包含：
    -   `theme.json`: 主题的配置文件
    -   `template.html`: Jinja2模板文件，定义卡片结构。
    -   `styles.css`: 样式文件。

#### `theme.json` 详解
```json
{
  "name": "深空蓝", // 主题的中文名
  "extends": "classic", // [可选] 继承自另一个主题的ID，会继承父主题的所有资源和配置
  "description": "现代、深邃的蓝色科技感主题。", // 主题描述
  "author": "ZhenxunBot", // 作者
  "assets": {
    "style": "styles.css" // [可选] 覆盖父主题的CSS文件
  },
  "palette": { // [可选] 定义或覆盖CSS变量，用于动态调整颜色、字体等
    "--card-bg-color": "#0F172A",
    "--text-color": "#E2E8F0",
    "--author-color": "#94A3B8",
    "--gradient-end": "rgba(15, 23, 42, 1)"
  }
}
```
**继承机制**是主题系统的优点。如上例，`classic-blue` 主题继承了 `classic` 主题的 `template.html` 和 `viewport` 配置，只提供了自己的 `styles.css` 和 `palette` 来实现全新的视觉风格，大大减少了工作量。

---
## 🤔 常见问题 (FAQ)

1.  **Q: 搜索功能好像不太准？**
    A: 请务必安装 `spacy_pkuseg` 依赖。没有它，插件无法进行中文分词，只能进行简单的全文匹配，效果会差很多。

2.  **Q: AI识别功能不工作怎么办？**
    A: 请检查以下几点：
    - 插件配置中 `AI_ENABLED` 是否已开启。
    - 真寻后台的 **[AI设置]** 中是否已正确配置了支持视觉的模型（如Gemini、GLM-4V等）。
    - 您的API Key是否有效且额度充足。
    - 检查机器人日志，看是否有相关的API错误信息。

3.  **Q: 安装PaddleOCR时出错或启动时提示缺少 `shm.dll` 等文件？**
    A: PaddleOCR的安装在Windows上可能比较复杂。
    - **首选方案**: 放弃PaddleOCR，使用 `easyocr`。它的兼容性最好，安装最简单。
    - **尝试解决**: 确保您已安装最新的 [Visual C++ Redistributable for Visual Studio](https://aka.ms/vs/17/release/vc_redist.x64.exe)，并检查PyTorch等相关库是否与您的CUDA版本匹配。如果问题复杂，切换到`easyocr`是更高效的选择。
---


## 📝 更新日志

### 🎉 v1.0.0 - 重大版本更新

#### 🔧 核心功能重构
- 🎨 **主题系统**：引入语录主题系统，支持HTML/CSS/JS自定义渲染
- 🔧 **查询优化**：重构语录查询逻辑，消除重复代码并提升性能
- 🤖 **AI升级**：升级AI-OCR功能，优先使用LLM服务并保留本地降级方案

#### ✨ 新增功能
- 📋 新增 `语录主题` 命令查看可用主题
- 🛠️ 新增 `语录管理` 主命令，支持批量删除和清理操作
- 🎯 支持通过 `-s [主题ID]` 参数指定语录生成主题
- 🎨 内置三种精美主题：**经典黑**、**深空蓝**、**手写回忆**
- 🔧 新增高级管理命令，支持按用户、关键词批量管理语录

#### 🚀 优化改进
- 🗂️ **路径优化**：支持相对路径存储，提升数据可移植性
- 🚀 **消息处理**：统一消息处理方式，简化回复和消息解析
- 🧹 **渲染升级**：移除旧版Pilmoji库，采用现代HTML渲染方案
- ⚡ **防重复**：避免短期内重复发送相同语录
- 📊 **统计增强**：支持跨群组查询和更详细的数据分析
- 🎛️ **配置完善**：新增主题和权限配置选项

---

### 🔄 历史版本

#### v0.4.5
- ✅ 支持多关键词AND模式搜索
- ✅ 支持自定义语录图片保存路径
- ✅ 统一图片格式为PNG并添加转换功能
- ✅ 优化图片文本字体自适应调整
- 🐛 修复删除语录时图片文件同步删除
- 🔧 重构文件路径操作使用pathlib
- 🔧 增强表情符号加载和文件处理健壮性

#### v0.4.4
- ✨ 添加 Gemini AI 识别功能
- 🎨 优化语录显示效果
- 🐛 修复用户名显示问题
- 📊 添加语录统计功能

#### v0.4.3
- ⚙️ 添加字体配置选项
- 🎨 优化语录生成效果
- 🐛 修复多处 Bug

#### v0.4.2
- 📦 添加批量上传和备份功能
- 🔍 优化 OCR 识别效果
- 🐛 修复标签管理问题

#### v0.4.1
- 🔍 添加多种 OCR 引擎支持
- 🔍 优化语录搜索功能
- 🐛 修复图片处理问题

#### v0.4.0
- 🎉 初始版本发布
## 🙏 致谢

-   **RongRongJi**: 本项目基于其开发的 [nonebot_plugin_quote](https://github.com/RongRongJi/nonebot_plugin_quote) 进行了大量重构和功能扩展，感谢原作者的杰出工作。
-   **真寻 (Zhenxun)**: 提供了稳定、强大的机器人框架和丰富的生态支持。

## 📄 许可证

本项目采用 [MIT License](./LICENSE) 开源。